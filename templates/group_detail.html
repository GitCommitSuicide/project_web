{% extends "base.html" %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Group Header -->
    <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6 mb-8">
        <div class="flex flex-col md:flex-row md:items-center justify-between">
            <div class="mb-4 md:mb-0">
                <h1 class="text-3xl font-bold text-gray-900 mb-2">{{ group.name }}</h1>
                {% if group.description %}
                <p class="text-gray-600 mb-2">{{ group.description }}</p>
                {% endif %}
                <div class="flex items-center space-x-4 text-sm text-gray-500">
                    <span><i class="fas fa-key mr-1"></i>Code: <span class="font-mono font-semibold">{{ group.code }}</span></span>
                    <span><i class="fas fa-users mr-1"></i>{{ members|length }} members</span>
                </div>
            </div>
            <div class="flex flex-col sm:flex-row gap-3">
                <a href="{{ url_for('add_expense', group_id=group.id) }}" class="bg-gradient-to-r from-primary-500 to-primary-600 text-white px-6 py-3 rounded-lg font-semibold hover:from-primary-600 hover:to-primary-700 transition-all transform hover:scale-105 shadow-lg text-center">
                    <i class="fas fa-plus mr-2"></i>Add Expense
                </a>
                <a href="{{ url_for('settle_up', group_id=group.id) }}" class="bg-accent-500 text-white px-6 py-3 rounded-lg font-semibold hover:bg-accent-600 transition-all text-center">
                    <i class="fas fa-handshake mr-2"></i>Settle Up
                </a>
                <a href="{{ url_for('download_pdf', group_id=group.id) }}" class="bg-purple-500 text-white px-6 py-3 rounded-lg font-semibold hover:bg-purple-600 transition-all text-center">
                    <i class="fas fa-download mr-2"></i>Download PDF
                </a>
            </div>
        </div>
    </div>

    <div class="grid lg:grid-cols-3 gap-8">
        <!-- Balances -->
        <div class="lg:col-span-1">
            <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">
                    <i class="fas fa-balance-scale mr-2 text-primary-500"></i>Balances
                </h2>
                {% if balances %}
                <div class="space-y-3">
                    {% for member in members %}
                        {% set balance = balances.get(member.id, 0) %}
                        <div class="flex items-center justify-between p-3 rounded-lg {% if balance > 0.01 %}bg-green-50 border border-green-200{% elif balance < -0.01 %}bg-red-50 border border-red-200{% else %}bg-gray-50 border border-gray-200{% endif %}">
                            <div class="flex items-center">
                                <div class="w-8 h-8 bg-gradient-to-r from-primary-500 to-accent-500 rounded-full flex items-center justify-center mr-3">
                                    <span class="text-white text-sm font-semibold">{{ member.name[0].upper() }}</span>
                                </div>
                                <span class="font-medium text-gray-900">{{ member.name }}</span>
                            </div>
                            <div class="text-right">
                                {% if balance > 0.01 %}
                                    <span class="text-green-600 font-semibold">+₹{{ "%.2f"|format(balance) }}</span>
                                    <div class="text-xs text-green-500">gets back</div>
                                {% elif balance < -0.01 %}
                                    <span class="text-red-600 font-semibold">-₹{{ "%.2f"|format(-balance) }}</span>
                                    <div class="text-xs text-red-500">owes</div>
                                {% else %}
                                    <span class="text-gray-500 font-semibold">₹0.00</span>
                                    <div class="text-xs text-gray-400">settled</div>
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-8">
                    <i class="fas fa-calculator text-gray-300 text-3xl mb-3"></i>
                    <p class="text-gray-500">No expenses yet</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Recent Expenses -->
        <div class="lg:col-span-2">
            <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-semibold text-gray-900">
                        <i class="fas fa-receipt mr-2 text-primary-500"></i>Recent Expenses
                    </h2>
                    {% if expenses %}
                    <span class="text-sm text-gray-500">{{ expenses|length }} expenses</span>
                    {% endif %}
                </div>
                
                {% if expenses %}
                <div class="space-y-4">
                    {% for expense in expenses %}
                    <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-all">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <h3 class="font-semibold text-gray-900 mb-1">{{ expense.description }}</h3>
                                <div class="flex items-center text-sm text-gray-500 mb-2">
                                    <i class="fas fa-user mr-1"></i>
                                    <span>Paid by {{ expense.payer.name }}</span>
                                    <span class="mx-2">•</span>
                                    <i class="fas fa-calendar mr-1"></i>
                                    <span>{{ expense.date.strftime('%b %d, %Y') }}</span>
                                </div>
                                <div class="text-sm text-gray-600">
                                    <i class="fas fa-users mr-1"></i>
                                    Split between: 
                                    {% set split_member_ids = expense.split_members.split(',') %}
                                    {% for member in members %}
                                        {% if member.id|string in split_member_ids %}
                                            <span class="inline-block bg-gray-100 rounded-full px-2 py-1 text-xs mr-1 mb-1">{{ member.name }}</span>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-2xl font-bold text-primary-600">₹{{ "%.2f"|format(expense.amount) }}</div>
                                <div class="text-sm text-gray-500 mb-2">
                                    ₹{{ "%.2f"|format(expense.amount / (expense.split_members.split(',')|length)) }} per person
                                </div>
                                <button onclick="deleteExpense({{ expense.id }})" class="text-red-500 hover:text-red-700 text-sm font-medium transition-all">
                                    <i class="fas fa-trash mr-1"></i>Delete
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-12">
                    <i class="fas fa-receipt text-gray-300 text-4xl mb-4"></i>
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">No expenses yet</h3>
                    <p class="text-gray-500 mb-6">Start by adding your first expense to this group</p>
                    <a href="{{ url_for('add_expense', group_id=group.id) }}" class="bg-gradient-to-r from-primary-500 to-primary-600 text-white px-6 py-3 rounded-lg font-semibold hover:from-primary-600 hover:to-primary-700 transition-all transform hover:scale-105 shadow-lg">
                        <i class="fas fa-plus mr-2"></i>Add First Expense
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl p-8 max-w-md mx-4">
        <div class="text-center">
            <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-exclamation-triangle text-red-500 text-2xl"></i>
            </div>
            <h3 class="text-xl font-semibold text-gray-900 mb-2">Delete Expense</h3>
            <p class="text-gray-600 mb-6">Are you sure you want to delete this expense? This action cannot be undone.</p>
            <div class="flex gap-4">
                <button id="cancelDelete" class="flex-1 bg-gray-100 text-gray-700 py-3 px-4 rounded-lg font-semibold hover:bg-gray-200 transition-all">
                    Cancel
                </button>
                <button id="confirmDelete" class="flex-1 bg-red-500 text-white py-3 px-4 rounded-lg font-semibold hover:bg-red-600 transition-all">
                    Delete
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let expenseToDelete = null;

function deleteExpense(expenseId) {
    expenseToDelete = expenseId;
    document.getElementById('deleteModal').classList.remove('hidden');
    document.getElementById('deleteModal').classList.add('flex');
}

document.getElementById('cancelDelete').addEventListener('click', function() {
    document.getElementById('deleteModal').classList.add('hidden');
    document.getElementById('deleteModal').classList.remove('flex');
    expenseToDelete = null;
});

document.getElementById('confirmDelete').addEventListener('click', async function() {
    if (!expenseToDelete) return;
    
    try {
        const response = await fetch(`/delete-expense/${expenseToDelete}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            showToast('Expense deleted successfully!', 'success');
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            showToast(result.message, 'error');
        }
    } catch (error) {
        showToast('An error occurred. Please try again.', 'error');
    }
    
    document.getElementById('deleteModal').classList.add('hidden');
    document.getElementById('deleteModal').classList.remove('flex');
    expenseToDelete = null;
});
</script>
{% endblock %}
